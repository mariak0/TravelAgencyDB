CREATE DATABASE travel_agency;
USE travel_agency;

CREATE TABLE branch(
br_code INT(11) NOT NULL AUTO_INCREMENT, 
br_street VARCHAR(30),
br_num INT(4),
br_city VARCHAR(30),
PRIMARY KEY (br_code)
);
	
ALTER TABLE branch AUTO_INCREMENT=21;

CREATE TABLE phones( 
ph_br_code INT(11) NOT NULL,
ph_number CHAR(10) NOT NULL,
PRIMARY KEY (ph_br_code, ph_number),
CONSTRAINT BRPHONES
FOREIGN KEY (ph_br_code) REFERENCES branch(br_code)
ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE worker(
wrk_AT CHAR(10) NOT NULL,
wrk_name VARCHAR(20),
wrk_lname VARCHAR(20),
wrk_salary FLOAT(7.2),
wrk_br_code INT(11)NOT NULL,
PRIMARY KEY (wrk_AT),
CONSTRAINT BRWORKER
FOREIGN KEY (wrk_br_code) REFERENCES branch(br_code)
ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE guide(
gui_AT CHAR(10) NOT NULL,
gui_cv TEXT NOT NULL,
PRIMARY KEY (gui_AT),
CONSTRAINT WORKGUIDE
FOREIGN KEY (gui_AT ) REFERENCES worker(wrk_AT)
ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE languages(
lng_gui_AT CHAR(10) NOT NULL,
lng_language VARCHAR(30) NOT NULL,
PRIMARY KEY (lng_gui_AT, lng_language),
CONSTRAINT GUIDELANGUAGE
FOREIGN KEY(lng_gui_AT) REFERENCES guide(gui_AT)
ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE driver(
drv_AT CHAR(10) NOT NULL,
drv_license ENUM('A', 'B', 'C', 'D'),
drv_route ENUM('LOCAL', 'ABROAD'),
drv_experience TINYINT(4),
PRIMARY KEY (drv_AT),
CONSTRAINT WORKDRIVER
FOREIGN KEY(drv_AT) REFERENCES worker(wrk_AT)
ON UPDATE CASCADE ON DELETE CASCADE
);
					
CREATE TABLE trip( 
tr_id INT(11) NOT NULL AUTO_INCREMENT,
tr_departure DATETIME NOT NULL,
tr_return DATETIME NOT NULL,
tr_maxseats TINYINT(4),
tr_cost FLOAT(7.2),
tr_br_code INT(11) NOT NULL,
tr_gui_AT CHAR(10) NOT NULL,
tr_drv_AT CHAR(10) NOT NULL,
PRIMARY KEY (tr_id),
CONSTRAINT BRANCHTRIP
FOREIGN KEY(tr_br_code) REFERENCES branch(br_code)
ON UPDATE CASCADE ON DELETE CASCADE,
CONSTRAINT GUIDETRIP
FOREIGN KEY(tr_gui_AT) REFERENCES guide(gui_AT )
ON UPDATE CASCADE ON DELETE CASCADE,
CONSTRAINT DRIVERTRIP
FOREIGN KEY(tr_drv_AT) REFERENCES driver(drv_AT)
ON UPDATE CASCADE ON DELETE CASCADE
);

ALTER TABLE trip AUTO_INCREMENT=101; 

CREATE TABLE event(
ev_tr_id INT(11) NOT NULL,
ev_start DATETIME NOT NULL,
ev_end DATETIME NOT NULL,
ev_descr TEXT NOT NULL,
PRIMARY KEY (ev_tr_id, ev_start),
CONSTRAINT TRIPEVENT
FOREIGN KEY(ev_tr_id) REFERENCES trip(tr_id)
ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE admin(
adm_AT CHAR(10) NOT NULL,
adm_type ENUM('LOGISTICS', 'ADMINISTRATIVE', 'ACCOUNTING'),
adm_diploma VARCHAR(200),
PRIMARY KEY (adm_AT),
CONSTRAINT WORKADMIN
FOREIGN KEY(adm_AT) REFERENCES worker(wrk_AT)
ON UPDATE CASCADE ON DELETE CASCADE
);
				   
CREATE TABLE manages(
mng_adm_AT CHAR(10) NOT NULL,
mng_br_code INT(11) NOT NULL,
PRIMARY KEY (mng_adm_AT, mng_br_code),
CONSTRAINT ADMMANAGES
FOREIGN KEY(mng_adm_AT) REFERENCES admin(adm_AT)
ON UPDATE CASCADE ON DELETE CASCADE,
CONSTRAINT BRANCHMANAGES
FOREIGN KEY(mng_br_code) REFERENCES branch(br_code)
ON UPDATE CASCADE ON DELETE CASCADE
);
					 
CREATE TABLE reservation(
res_tr_id INT(11) NOT NULL,
res_seatnum TINYINT(4) NOT NULL,
res_name VARCHAR(20),
res_lname VARCHAR(20),
res_isadult ENUM('ADULT', 'MINOR'),
PRIMARY KEY (res_tr_id, res_seatnum),
CONSTRAINT TRIPRESERV
FOREIGN KEY(res_tr_id) REFERENCES trip(tr_id)
ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE destination(
dst_id INT(11) NOT NULL AUTO_INCREMENT,
dst_name VARCHAR(50),
dst_descr TEXT NOT NULL,
dst_rtype ENUM('LOCAL', 'ABROAD'),
dst_language VARCHAR(30),
dst_location INT(11) NOT NULL,
PRIMARY KEY (dst_id),
CONSTRAINT DESTINATION
FOREIGN KEY(dst_location) REFERENCES destination(dst_id)
ON UPDATE CASCADE ON DELETE CASCADE
);
ALTER TABLE destination AUTO_INCREMENT=161; 

CREATE TABLE travel_to(
to_tr_id INT(11) NOT NULL,
to_dst_id INT(11) NOT NULL,
to_arrival DATETIME NOT NULL,
to_departure DATETIME NOT NULL,
PRIMARY KEY (to_tr_id, to_dst_id),
CONSTRAINT TRIPTRAVEL
FOREIGN KEY(to_tr_id) REFERENCES trip(tr_id)
ON UPDATE CASCADE ON DELETE CASCADE,
CONSTRAINT DESTINATIONTRAVEL
FOREIGN KEY(to_dst_id) REFERENCES destination(dst_id)
ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE TABLE IT( IT_AT CHAR(10) NOT NULL,
                 password VARCHAR(10) NOT NULL default'password',
				 start_date DATE NOT NULL,
				 end_date DATE NOT NULL,
				 PRIMARY KEY(IT_AT),
				 CONSTRAINT WORKERIT
				 FOREIGN KEY(IT_AT) REFERENCES worker(wrk_AT)
				 ON UPDATE CASCADE ON DELETE CASCADE
				 );
				 
				 
CREATE TABLE OFFERS(code_offer INT AUTO_INCREMENT NOT NULL,
                    begin_date DATE NOT NULL,
					end_date   DATE NOT NULL,
					cost FLOAT NOT NULL,
					offer_dst_id INT(11) NOT NULL,
					PRIMARY KEY(code_offer),
				   CONSTRAINT DESTOFFER
				   FOREIGN KEY(offer_dst_id ) REFERENCES destination(dst_id)
				   ON UPDATE CASCADE ON DELETE CASCADE
				    );

ALTER TABLE OFFERS AUTO_INCREMENT=0;

CREATE TABLE reservation_offers(res_code INT NOT NULL AUTO_INCREMENT,
                                lname VARCHAR(20),
								fname VARCHAR(20),
								res_code_offer INT NOT NULL,
								advance_payment FLOAT NOT NULL,
								PRIMARY KEY(res_code),
				   CONSTRAINT OFFERRESRVATION
				   FOREIGN KEY(res_code_offer) REFERENCES OFFERS(code_offer)
				   ON UPDATE CASCADE ON DELETE CASCADE
				    );

ALTER TABLE reservation_offers AUTO_INCREMENT=0;

CREATE TABLE log_trip (
     A_T INT(11) NOT NULL AUTO_INCREMENT,  
  action VARCHAR(255),
   action_time  TIMESTAMP,
   table_name VARCHAR(20) NOT NULL,
	table_username VARCHAR(20) NOT NULL,
   PRIMARY KEY(A_T)
 );
 
 ALTER TABLE log_trip AUTO_INCREMENT=0;
